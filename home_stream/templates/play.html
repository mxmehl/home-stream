{% extends "base.html" %}
{% block content %}
<h2>Player</h2>

{% if is_playlist %}
<p><strong>Now Playing:</strong> <span id="now-playing">{{ files[0].name }}</span></p>

<{{ mediatype }} id="media-player" controls autoplay preload></{{ mediatype }}>
<ul class="files" id="playlist">
  {% for file in files %}
    <li data-src="{{ file.stream_url }}">
      <span class="track" onclick="playFromList(this)">{{ file.name }}</span>
    </li>
  {% endfor %}
</ul>

<script>
const player = document.getElementById("media-player");
const playlistItems = [...document.querySelectorAll("#playlist li")];
const nowPlaying = document.getElementById("now-playing");
let index = 0;

function setActive(i) {
  playlistItems.forEach((item, j) => {
    item.classList.toggle("active", j === i);
  });
  nowPlaying.textContent = playlistItems[i].textContent;
}

function playFromList(el) {
  const li = el.closest("li");
  index = playlistItems.indexOf(li);
  player.src = li.dataset.src;
  player.play();
  setActive(index);
}

function playNext() {
  if (index + 1 < playlistItems.length) {
    index++;
    player.src = playlistItems[index].dataset.src;
    player.play();
    setActive(index);
  }
}

player.addEventListener("ended", playNext);

// Initialize
player.src = playlistItems[0].dataset.src;
setActive(0);
</script>

{% else %}
<{{ mediatype }} controls autoplay preload>
  <source src="{{ stream_url }}">
  Your browser does not support the {{ mediatype }} tag.
</{{ mediatype }}>
{% endif %}
{% endblock %}
